name: Brew Tap
description: Homebrew Tap

inputs:
  HOMEBREW_GITHUB_API_TOKEN:
    description: "Homebrew GitHub API Token"
    required: true
  HOMEBREW_BRANCH:
    description: "Homebrew Branch"
    required: false
    default: "main"

runs:
  using: "composite"

  steps:
    - name: Add Tap
      env:
        HOMEBREW_GITHUB_API_TOKEN: ${{ inputs.HOMEBREW_GITHUB_API_TOKEN }}
      shell: bash -ieo pipefail {0}
      run: |
        brew tap brewforge/chinese
        cd "$(brew --repository brewforge/chinese)"
        git checkout ${{ github.head_ref || github.ref_name }}
        git fetch && git reset --hard origin/${{ github.head_ref || github.ref_name }}
        brew update

    - name: Install Homebrew's dependencies
      shell: bash -ieo pipefail {0}
      run: |
        brew install ripgrep sd gcc coreutils jq
        brew unlink coreutils && brew link coreutils
        brew install-bundler-gems --groups "audit,style"

    - uses: oleksiyrudenko/gha-git-credentials@v2-latest
      with:
        global: true
        name: "Brewforge-Bot"
        email: "brewforge-bot@aliyun.com"
        token: "${{ inputs.HOMEBREW_GITHUB_API_TOKEN }}"

    - name: show git context
      shell: bash -ieo pipefail {0}
      run: |
        cat $HOME/.gitconfig
        cat $GITHUB_ENV
